<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOJO NFT Collection - Admin Panel</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png?v=2">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png?v=2">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=2">
    <link rel="shortcut icon" href="favicon.ico?v=2">
    <!-- Paco Platform Fee Wallet: Configured via environment variable -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="single-page.css">
    <style>
        .admin-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--glass-bg-dark);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            backdrop-filter: blur(18px);
            box-shadow: var(--glass-shadow);
            position: relative;
        }

        .admin-hero {
            display: flex;
            justify-content: center;
            margin: 1rem 0 2rem 0;
        }
        .admin-hero img {
            height: 56px;
            width: auto;
            filter: drop-shadow(0 2px 8px rgba(135, 206, 235, 0.35));
        }
        
        .deploy-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 1px solid var(--surface-accent);
            border-radius: var(--border-radius-md);
            background: var(--surface-darker);
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--restaurant-yellow);
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .deploy-btn {
            background: linear-gradient(135deg, var(--mojo-ice), var(--mojo-blue));
            color: var(--mojo-dark);
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all var(--transition-base);
            margin-top: 1rem;
        }
        
        .deploy-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(135, 206, 235, 0.45);
        }
        
        .deploy-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status-section {
            margin-top: 2rem;
            padding: 1rem;
            background: var(--glass-bg-dark);
            border-radius: var(--border-radius-md);
            border: 1px solid var(--glass-border);
        }
        
        .deployed-contracts {
            margin-top: 2rem;
        }
        
        .contract-card {
            background: var(--glass-bg-dark);
            padding: 1rem;
            border-radius: var(--border-radius-md);
            margin-bottom: 1rem;
            border: 1px solid var(--glass-border);
        }
        
        .contract-address {
            font-family: 'Courier New', monospace;
            background: var(--surface-dark);
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            margin: 0.5rem 0;
            word-break: break-all;
        }
        
        .copy-btn {
            background: var(--mojo-ice);
            color: var(--mojo-dark);
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        /* Admin Controls Styling */
        .admin-controls h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .admin-section {
            margin-bottom: 2rem;
        }
        
        .admin-section h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .admin-section p {
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffd166, #fcbf49);
            color: #1a1a1a;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .btn-warning:hover {
            background: #ffca7a;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #e63946);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .admin-container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .admin-section {
                padding: 1rem;
            }
        }
    </style>
</head>
<body style="background: url('BG.png') center/cover no-repeat fixed; color: var(--mojo-white);">
    <div class="admin-hero">
        <img src="TITLE.png" alt="MOJO Admin" />
    </div>
    <div id="adminGate" style="max-width: 480px; margin: 4rem auto; background: var(--surface-dark); border: 1px solid var(--surface-accent); border-radius: var(--border-radius-lg); padding: 1.5rem; text-align: center;">
        <h2 style="margin-bottom: 1rem;">Admin Access</h2>
        <p style="margin-bottom: 1rem; color: var(--text-muted);">Enter passcode to continue</p>
        <input id="adminPassInput" type="password" placeholder="Passcode" style="width: 100%; padding: 0.75rem; border-radius: var(--border-radius-md); border: 1px solid var(--surface-accent); background: var(--surface-darker); color: var(--text-primary);" />
        <button id="adminPassBtn" style="margin-top: 1rem; width: 100%; padding: 0.75rem; border-radius: var(--border-radius-md); border: none; background: var(--restaurant-green); color: white; font-weight: 700; cursor: pointer;">Unlock</button>
        <div id="adminPassMsg" style="margin-top: 0.75rem; color: var(--restaurant-red); display:none;">Incorrect passcode</div>
        <p style="margin-top: 0.75rem; color: var(--text-muted); font-size: 0.85rem;">Hint: set window.ADMIN_PASS in console for dev</p>
    </div>
    
    <div class="admin-container" id="adminApp" style="display:none;">
        <h1>üé® MOJO NFT Collection Setup</h1>
        <p>Deploy your MOJO NFT smart contract - <strong>One-time setup required</strong></p>
        
        <div class="info-box" style="background: var(--glass-bg-dark); padding: 1rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-yellow); border: 1px solid var(--glass-border);">
            <h3>üìã Before You Start:</h3>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li>You only need to do this <strong>ONCE</strong> for your collection</li>
                <li><strong>Gas fees on Abstract:</strong> typically just a few cents per transaction thanks to L2 batching and efficient proofs.</li>
                <li>Choose your collection details carefully (name/symbol can't be changed)</li>
                <li>After deployment, copy the contract address to your main app</li>
            </ul>
        </div>
        
        <div class="deploy-form">
            <div class="form-group">
                <label for="collectionName">Collection Name</label>
                <input type="text" id="collectionName" placeholder="e.g., MOJO PFP Collection" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="symbol">Symbol</label>
                    <input type="text" id="symbol" placeholder="e.g., MOJO" maxlength="10" required>
                </div>
                
                <div class="form-group">
                    <label for="maxSupply">Max Supply</label>
                    <input type="number" id="maxSupply" placeholder="10000" min="1" max="100000" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="mintPrice">Mint Price (ETH)</label>
                    <input type="number" id="mintPrice" placeholder="0.01" step="0.001" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="royaltyPercent">Royalty %</label>
                    <input type="number" id="royaltyPercent" placeholder="7.5" step="0.1" min="0" max="10" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="royaltyReceiver">Royalty Receiver Address</label>
                <input type="text" id="royaltyReceiver" placeholder="0x..." required>
            </div>
            
            <div class="form-group">
                <label for="network">Network</label>
                <select id="network" required>
                    <option value="abstract" selected>Abstract</option>
                </select>
            </div>
            
            <div class="deployment-options" style="margin: 2rem 0;">
                <h3>üöÄ Deploy Your MOJO Contract:</h3>
                
                <div class="option-card" style="background: var(--glass-bg-dark); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 1rem; border: 2px solid var(--mojo-ice); border: 1px solid var(--glass-border);">
                    <h4>üìñ Deploy via Remix IDE (Recommended)</h4>
                    <p>Copy contract code and deploy manually - no gas fees until you're ready</p>
                    <button class="deploy-btn" onclick="showRemixInstructions()" style="background: var(--mojo-ice); color: var(--mojo-dark);">
                        üìã Get Contract Code & Instructions
                    </button>
                </div>
            </div>
        </div>
        
        <div class="status-section" id="statusSection" style="display: none;">
            <h3>Deployment Status</h3>
            <div id="statusText">Ready to deploy...</div>
            <div id="progressBar" style="display: none;">
                <div style="background: var(--restaurant-green); height: 4px; border-radius: 2px; width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>
        
        <!-- Remix Instructions Modal -->
        <div id="remixModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
            <div style="background: var(--surface-dark); margin: 2rem auto; max-width: 800px; border-radius: var(--border-radius-lg); max-height: 90vh; overflow-y: auto;">
                <div style="padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2>üéØ Easy Contract Deployment Guide</h2>
                        <button onclick="closeRemixModal()" style="background: var(--restaurant-red); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--border-radius-md); cursor: pointer;">‚úï Close</button>
                    </div>
                    
                    <div class="step-guide">
                        <div class="step">
                            <h3>üìù Step 1: Prepare Your Information</h3>
                            <p>Fill out the form above first, then copy these values:</p>
                            <div id="contractParams" style="background: var(--surface-darker); padding: 1rem; border-radius: var(--border-radius-md); margin: 1rem 0; font-family: monospace;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="step">
                            <h3>üåê Step 2: Open Remix IDE</h3>
                            <p>Go to <a href="https://remix.ethereum.org" target="_blank" style="color: var(--restaurant-yellow);">remix.ethereum.org</a> in a new tab</p>
                        </div>
                        
                        <div class="step">
                            <h3>üìÑ Step 3: Create Contract File</h3>
                            <ol>
                                <li>Click "Create New File" in Remix</li>
                                <li>Name it: <code>MojoNFT.sol</code></li>
                                <li>Copy and paste this contract code:</li>
                            </ol>
                            <button onclick="copyContractCode()" style="background: var(--restaurant-green); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--border-radius-md); cursor: pointer; margin: 0.5rem 0;">üìã Copy Contract Code</button>
                            <textarea id="contractCode" readonly style="width: 100%; height: 200px; background: var(--surface-darker); color: var(--text-primary); border: 1px solid var(--surface-accent); border-radius: var(--border-radius-md); padding: 1rem; font-family: monospace; font-size: 0.8rem;"></textarea>
                        </div>
                        
                        <div class="step">
                            <h3>‚öôÔ∏è Step 4: Compile Contract</h3>
                            <ol>
                                <li>Click the "Solidity Compiler" tab (üìÑ icon)</li>
                                <li>Select compiler version: <strong>0.8.19</strong></li>
                                <li>Click "Compile MojoNFT.sol"</li>
                                <li>Wait for green checkmark ‚úÖ</li>
                            </ol>
                        </div>
                        
                        <div class="step">
                            <h3>üöÄ Step 5: Deploy Contract</h3>
                            <ol>
                                <li>Click "Deploy & Run Transactions" tab (üöÄ icon)</li>
                                <li>Select "Injected Provider - MetaMask"</li>
                                <li>Choose your network (Ethereum, Polygon, etc.)</li>
                                <li>Select "MojoNFT_Template" contract</li>
                                <li>Fill in constructor parameters (use values from Step 1)</li>
                                <li>Click "Deploy" and confirm in MetaMask</li>
                            </ol>
                        </div>
                        
                        <div class="step">
                            <h3>‚úÖ Step 6: Get Contract Address</h3>
                            <ol>
                                <li>After deployment, find your contract in "Deployed Contracts"</li>
                                <li>Copy the contract address (starts with 0x...)</li>
                                <li>Update your main NFT generator with this address</li>
                                <li>You're ready to mint NFTs! üéâ</li>
                            </ol>
                        </div>
                        
                        <div style="background: var(--restaurant-green); color: white; padding: 1rem; border-radius: var(--border-radius-md); margin-top: 2rem;">
                            <h4>üéØ Final Step:</h4>
                            <p>Update your <code>script.js</code> file with the new contract address:</p>
                            <code style="background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 4px; display: block; margin-top: 0.5rem;">
                                const NFT_CONTRACT_ADDRESS = "0xYourNewContractAddress";
                            </code>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="deployed-contracts" id="deployedContracts">
            <h3>üìã Next Steps</h3>
            <div style="background: var(--glass-bg-dark); padding: 1rem; border-radius: var(--border-radius-md); border-left: 4px solid var(--mojo-ice); border: 1px solid var(--glass-border);">
                <p><strong>After deploying via Remix:</strong></p>
                <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                    <li>Copy your deployed contract address</li>
                    <li>Update <code>NFT_CONTRACT_ADDRESS</code> in your main app's <code>config.js</code></li>
                    <li>Use the Contract Management section below to configure your collection</li>
                    <li>Set up Pinata IPFS integration in your main app</li>
                </ol>
            </div>
        </div>

        <!-- Admin Controls Section -->
        <div class="admin-controls" id="adminControls" style="margin-top: 3rem;">
            <h2>‚öôÔ∏è Contract Management</h2>
            <p>Manage your deployed NFT contract settings</p>
            
            <!-- Contract Address Input -->
            <div class="form-group" style="margin-bottom: 2rem;">
                <label for="contractAddress">Contract Address</label>
                <input type="text" id="contractAddress" placeholder="0x..." style="width: 100%;">
                <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">Enter your deployed contract address to enable management features</small>
            </div>
            
            <!-- Payout Wallet Management -->
            <div class="admin-section" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-green);">
                <h3>üí∞ Payout Wallet Configuration</h3>
                <p>Set where NFT sale proceeds and royalties are sent</p>
                
                <div class="form-group">
                    <label for="payoutWallet">Payout Wallet Address</label>
                    <input type="text" id="payoutWallet" placeholder="0x6Dc7277Da5842041f4af527Fe6f6A209EF03BED4" style="width: 100%;">
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadCurrentPayoutWallet()" style="margin-right: 1rem;">
                        üìã Load Current
                    </button>
                    <button class="btn btn-primary" onclick="updatePayoutWallet()">
                        üíæ Update Payout Wallet
                    </button>
                </div>
                
                <div id="payoutStatus" style="margin-top: 1rem; display: none;"></div>
            </div>
            
            <!-- Supply Management -->
            <div class="admin-section" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-red);">
                <h3>üìä Supply Management</h3>
                <p>Manage the maximum supply of your NFT collection</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentSupply">Current Supply</label>
                        <input type="text" id="currentSupply" readonly style="background: var(--surface-accent);">
                    </div>
                    
                    <div class="form-group">
                        <label for="currentMaxSupply">Current Max Supply</label>
                        <input type="text" id="currentMaxSupply" readonly style="background: var(--surface-accent);">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newMaxSupply">New Max Supply</label>
                    <input type="number" id="newMaxSupply" placeholder="5000" min="1">
                    <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">‚ö†Ô∏è Can only be reduced, not increased. This will limit future minting.</small>
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadSupplyInfo()" style="margin-right: 1rem;">
                        üìä Refresh Supply Info
                    </button>
                    <button class="btn btn-warning" onclick="updateMaxSupply()" style="margin-right: 1rem;">
                        ‚ö†Ô∏è Reduce Max Supply
                    </button>
                    <button class="btn btn-danger" onclick="burnTokens()">
                        üî• Burn Unsold Supply
                    </button>
                </div>
                
                <div id="supplyStatus" style="margin-top: 1rem; display: none;"></div>
            </div>
            
            <!-- Minting Controls -->
            <div class="admin-section" style="background: var(--glass-bg-dark); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--mojo-ice); border: 1px solid var(--glass-border);">
                <h3>üéõÔ∏è Minting Controls</h3>
                <p>Enable or disable minting for your collection</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentMintingState">Current Minting State</label>
                        <input type="text" id="currentMintingState" readonly style="background: var(--surface-accent);">
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadMintingState()" style="margin-right: 1rem;">
                        üîÑ Refresh State
                    </button>
                    <button class="btn btn-warning" onclick="toggleMintingState()">
                        ‚èØÔ∏è Toggle Minting
                    </button>
                </div>
                
                <div id="mintingStatus" style="margin-top: 1rem; display: none;"></div>
            </div>

            <!-- Mint Price Management -->
            <div class="admin-section" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-blue);">
                <h3>üíé Pricing Controls</h3>
                <p>Adjust the mint price for your NFTs</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentMintPrice">Current Mint Price (ETH)</label>
                        <input type="text" id="currentMintPrice" readonly style="background: var(--surface-accent);">
                    </div>
                    
                    <div class="form-group">
                        <label for="newMintPrice">New Mint Price (ETH)</label>
                        <input type="number" id="newMintPrice" placeholder="0.01" step="0.001" min="0">
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadMintPrice()" style="margin-right: 1rem;">
                        üí∞ Load Current Price
                    </button>
                    <button class="btn btn-primary" onclick="updateMintPrice()">
                        üíæ Update Mint Price
                    </button>
                </div>
                
                <div id="priceStatus" style="margin-top: 1rem; display: none;"></div>
            </div>

            <!-- Royalty Management -->
            <div class="admin-section" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-orange);">
                <h3>üëë Royalty Management</h3>
                <p>Configure royalties for secondary sales on OpenSea and other marketplaces</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentRoyaltyReceiver">Current Royalty Receiver</label>
                        <input type="text" id="currentRoyaltyReceiver" readonly style="background: var(--surface-accent);">
                    </div>
                    
                    <div class="form-group">
                        <label for="currentRoyaltyPercentage">Current Royalty %</label>
                        <input type="text" id="currentRoyaltyPercentage" readonly style="background: var(--surface-accent);">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newRoyaltyReceiver">New Royalty Receiver Address</label>
                        <input type="text" id="newRoyaltyReceiver" placeholder="0x..." style="width: 100%;">
                    </div>
                    
                    <div class="form-group">
                        <label for="newRoyaltyPercentage">New Royalty Percentage</label>
                        <input type="number" id="newRoyaltyPercentage" placeholder="7.5" step="0.1" min="0" max="10">
                        <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">Maximum 10% allowed</small>
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadRoyaltyInfo()" style="margin-right: 1rem;">
                        üëë Load Current Royalties
                    </button>
                    <button class="btn btn-primary" onclick="updateRoyaltyInfo()">
                        üíæ Update Royalties
                    </button>
                </div>
                
                <div id="royaltyStatus" style="margin-top: 1rem; display: none;"></div>
            </div>

            <!-- Escrow Management -->
            <div class="admin-section" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--mojo-ice);">
                <h3>üîí Escrow Management</h3>
                <p>Manage NFTs held in escrow - only you can release them to users</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="totalPendingTokens">Total Pending NFTs</label>
                        <input type="text" id="totalPendingTokens" readonly style="background: var(--surface-accent);">
                    </div>
                    
                    <div class="form-group">
                        <label for="totalClaimedTokens">Total Released NFTs</label>
                        <input type="text" id="totalClaimedTokens" readonly style="background: var(--surface-accent);">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="userAddressLookup">User Address (to check pending NFTs)</label>
                    <input type="text" id="userAddressLookup" placeholder="0x..." style="width: 100%;">
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadEscrowStats()" style="margin-right: 1rem;">
                        üìä Refresh Escrow Stats
                    </button>
                    <button class="btn btn-info" onclick="checkUserPendingTokens()" style="margin-right: 1rem;">
                        üîç Check User Tokens
                    </button>
                    <button class="btn btn-warning" onclick="showAllPendingTokens()" style="margin-right: 1rem;">
                        üìã Show All Pending
                    </button>
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="tokenIdToRelease">Token ID to Release</label>
                    <input type="number" id="tokenIdToRelease" placeholder="1" min="1">
                </div>
                
                <div class="form-group">
                    <label for="userAddressToRelease">Release All Tokens for User</label>
                    <input type="text" id="userAddressToRelease" placeholder="0x..." style="width: 100%;">
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-success" onclick="releaseSingleToken()" style="margin-right: 1rem;">
                        üöÄ Release Single NFT
                    </button>
                    <button class="btn btn-success" onclick="releaseAllUserTokens()" style="margin-right: 1rem;">
                        üéÅ Release All User NFTs
                    </button>
                    <button class="btn btn-danger" onclick="releaseAllPendingTokens()">
                        ‚ö° Release ALL Pending NFTs
                    </button>
                </div>
                
                <div id="escrowStatus" style="margin-top: 1rem; display: none;"></div>
                
                <!-- Pending Tokens Display -->
                <div id="pendingTokensList" style="margin-top: 2rem; display: none;">
                    <h4>üìã Pending NFTs in Escrow</h4>
                    <div id="pendingTokensContent" style="max-height: 300px; overflow-y: auto; background: var(--surface-accent); padding: 1rem; border-radius: var(--border-radius-sm);"></div>
                </div>
            </div>

            <!-- Collection Management -->
            <div class="admin-section" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-green);">
                <h3>üé® Collection Management</h3>
                <p>Manage collection metadata and uniqueness settings</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="collectionTotalSupply">Total Minted</label>
                        <input type="text" id="collectionTotalSupply" readonly style="background: var(--surface-accent);">
                    </div>
                    
                    <div class="form-group">
                        <label for="collectionMaxSupply">Max Supply</label>
                        <input type="text" id="collectionMaxSupply" readonly style="background: var(--surface-accent);">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="collectionDescription">Collection Description</label>
                    <textarea id="collectionDescription" rows="3" style="width: 100%;" placeholder="Update collection description..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="collectionExternalUrl">External URL</label>
                        <input type="url" id="collectionExternalUrl" placeholder="https://mojotheyeti.com/" style="width: 100%;">
                    </div>
                    
                    <div class="form-group">
                        <label for="collectionImageUrl">Collection Image URL</label>
                        <input type="url" id="collectionImageUrl" placeholder="https://..." style="width: 100%;">
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadCollectionStats()" style="margin-right: 1rem;">
                        üìä Load Collection Info
                    </button>
                    <button class="btn btn-primary" onclick="updateCollectionMetadata()">
                        üíæ Update Collection
                    </button>
                </div>
                
                <div id="collectionStatus" style="margin-top: 1rem; display: none;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script>
        // ===== Simple Admin Passcode Gate =====
        (function() {
            const gate = document.getElementById('adminGate');
            const app = document.getElementById('adminApp');
            const input = document.getElementById('adminPassInput');
            const btn = document.getElementById('adminPassBtn');
            const msg = document.getElementById('adminPassMsg');

            // Configure passcode here (client-side). For real security, use HTTP Basic Auth or server middleware.
            const PASS = window.ADMIN_PASS || 'mojo420!';

            function unlock() {
                const val = (input.value || '').trim();
                if (val === PASS) {
                    gate.style.display = 'none';
                    app.style.display = '';
                } else {
                    msg.style.display = '';
                }
            }

            btn.addEventListener('click', unlock);
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') unlock(); });
        })();

        // Contract template for deployment
        const CONTRACT_TEMPLATE = `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Counters.sol";

contract MojoNFT_Template is ERC721, ERC721URIStorage, Ownable, ReentrancyGuard {
    using Counters for Counters.Counter;
    Counters.Counter private _tokenIdCounter;
    
    uint256 public immutable MAX_SUPPLY;
    uint256 public mintPrice;
    bool public mintingActive = true;
    address public royaltyReceiver;
    uint96 public royaltyFeeNumerator;
    
    constructor(
        string memory name,
        string memory symbol,
        uint256 _mintPrice,
        uint256 _maxSupply,
        address _royaltyReceiver,
        uint96 _royaltyFeeNumerator
    ) ERC721(name, symbol) {
        mintPrice = _mintPrice;
        MAX_SUPPLY = _maxSupply;
        royaltyReceiver = _royaltyReceiver;
        royaltyFeeNumerator = _royaltyFeeNumerator;
        _tokenIdCounter.increment();
    }
    
    function mint(address to, string memory tokenURI) public payable nonReentrant returns (uint256) {
        require(mintingActive, "Minting is not active");
        require(msg.value >= mintPrice, "Insufficient payment");
        require(_tokenIdCounter.current() <= MAX_SUPPLY, "Max supply exceeded");
        require(to != address(0), "Cannot mint to zero address");
        
        uint256 tokenId = _tokenIdCounter.current();
        _tokenIdCounter.increment();
        
        _safeMint(to, tokenId);
        _setTokenURI(tokenId, tokenURI);
        
        return tokenId;
    }
    
    function setMintPrice(uint256 newPrice) public onlyOwner {
        mintPrice = newPrice;
    }
    
    function toggleMinting() public onlyOwner {
        mintingActive = !mintingActive;
    }
    
    function withdraw() public onlyOwner {
        uint256 balance = address(this).balance;
        require(balance > 0, "No funds to withdraw");
        (bool success, ) = payable(owner()).call{value: balance}("");
        require(success, "Withdrawal failed");
    }
    
    function totalSupply() public view returns (uint256) {
        return _tokenIdCounter.current() - 1;
    }
    
    function tokensOfOwner(address owner) public view returns (uint256[] memory) {
        uint256 tokenCount = balanceOf(owner);
        if (tokenCount == 0) return new uint256[](0);
        
        uint256[] memory tokenIds = new uint256[](tokenCount);
        uint256 index = 0;
        
        for (uint256 tokenId = 1; tokenId < _tokenIdCounter.current(); tokenId++) {
            if (_exists(tokenId) && ownerOf(tokenId) == owner) {
                tokenIds[index++] = tokenId;
                if (index == tokenCount) break;
            }
        }
        return tokenIds;
    }
    
    function royaltyInfo(uint256, uint256 salePrice) external view returns (address receiver, uint256 royaltyAmount) {
        receiver = royaltyReceiver;
        royaltyAmount = (salePrice * royaltyFeeNumerator) / 10000;
    }
    
    function _burn(uint256 tokenId) internal override(ERC721, ERC721URIStorage) {
        super._burn(tokenId);
    }
    
    function tokenURI(uint256 tokenId) public view override(ERC721, ERC721URIStorage) returns (string memory) {
        return super.tokenURI(tokenId);
    }
    
    function supportsInterface(bytes4 interfaceId) public view override(ERC721, ERC721URIStorage) returns (bool) {
        return interfaceId == 0x2a55205a || super.supportsInterface(interfaceId);
    }
}`;
        
        // No factory needed - direct contract deployment via Remix
        
        let web3Provider = null;
        let signer = null;
        let userAddress = null;
        
        // Connect wallet on page load
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                        loadDeployedContracts();
                    }
                } catch (error) {
                    console.error('Auto-connect failed:', error);
                }
            }
        });
        
        async function connectWallet() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                web3Provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = web3Provider.getSigner();
                userAddress = accounts[0];
                
                updateStatus(`Connected: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`, 'success');
                return true;
            } catch (error) {
                updateStatus('Failed to connect wallet', 'error');
                return false;
            }
        }
        
        // Contract deployment is handled via Remix IDE - no complex factory needed
        
        function updateStatus(message, type = 'info') {
            const statusSection = document.getElementById('statusSection');
            const statusText = document.getElementById('statusText');
            
            statusSection.style.display = 'block';
            statusText.textContent = message;
            
            // Update styling based on type
            statusSection.style.borderLeftColor = 
                type === 'success' ? 'var(--restaurant-green)' :
                type === 'error' ? 'var(--restaurant-red)' :
                type === 'warning' ? 'var(--restaurant-orange)' :
                'var(--restaurant-yellow)';
        }
        
        // Deployment handled via Remix - no button state needed
        
        function addDeployedContract(contract) {
            const contractsList = document.getElementById('contractsList');
            
            // Remove "no contracts" message if it exists
            if (contractsList.children.length === 1 && contractsList.children[0].tagName === 'P') {
                contractsList.innerHTML = '';
            }
            
            const contractCard = document.createElement('div');
            contractCard.className = 'contract-card';
            contractCard.innerHTML = `
                <h4>${contract.name} (${contract.symbol})</h4>
                <div class="contract-address">
                    ${contract.address}
                    <button class="copy-btn" onclick="copyToClipboard('${contract.address}')">Copy</button>
                </div>
                <p><strong>Network:</strong> ${contract.network}</p>
                <p><strong>Transaction:</strong> 
                    <a href="https://etherscan.io/tx/${contract.txHash}" target="_blank" style="color: var(--restaurant-yellow);">
                        View on Explorer
                    </a>
                </p>
            `;
            
            contractsList.insertBefore(contractCard, contractsList.firstChild);
            
            // Save to localStorage
            saveContractToStorage(contract);
        }
        
        function loadDeployedContracts() {
            const saved = localStorage.getItem('deployedContracts');
            if (saved) {
                const contracts = JSON.parse(saved);
                contracts.forEach(contract => addDeployedContract(contract));
            }
        }
        
        function saveContractToStorage(contract) {
            const saved = localStorage.getItem('deployedContracts');
            const contracts = saved ? JSON.parse(saved) : [];
            contracts.unshift(contract);
            localStorage.setItem('deployedContracts', JSON.stringify(contracts));
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                updateStatus('Address copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }
        
        // Remix Instructions Functions
        function showRemixInstructions() {
            // Validate form first
            const collectionName = document.getElementById('collectionName').value.trim();
            const symbol = document.getElementById('symbol').value.trim().toUpperCase();
            const maxSupply = document.getElementById('maxSupply').value;
            const mintPrice = document.getElementById('mintPrice').value;
            const royaltyPercent = document.getElementById('royaltyPercent').value;
            const royaltyReceiver = document.getElementById('royaltyReceiver').value.trim();
            
            if (!collectionName || !symbol || !maxSupply || !mintPrice || !royaltyPercent || !royaltyReceiver) {
                updateStatus('Please fill in all fields above first', 'error');
                return;
            }
            
            // Populate contract parameters
            const mintPriceWei = (parseFloat(mintPrice) * 1e18).toString();
            const royaltyBasisPoints = Math.round(parseFloat(royaltyPercent) * 100);
            
            const paramsHtml = `
                <strong>Constructor Parameters (copy these exactly):</strong><br><br>
                <strong>name:</strong> "${collectionName}"<br>
                <strong>symbol:</strong> "${symbol}"<br>
                <strong>_mintPrice:</strong> ${mintPriceWei}<br>
                <strong>_maxSupply:</strong> ${maxSupply}<br>
                <strong>_royaltyReceiver:</strong> ${royaltyReceiver}<br>
                <strong>_royaltyFeeNumerator:</strong> ${royaltyBasisPoints}
            `;
            
            document.getElementById('contractParams').innerHTML = paramsHtml;
            document.getElementById('contractCode').value = CONTRACT_TEMPLATE;
            document.getElementById('remixModal').style.display = 'block';
        }
        
        function closeRemixModal() {
            document.getElementById('remixModal').style.display = 'none';
        }
        
        function copyContractCode() {
            const contractCode = document.getElementById('contractCode');
            contractCode.select();
            contractCode.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(contractCode.value).then(() => {
                updateStatus('Contract code copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                updateStatus('Failed to copy code - please select and copy manually', 'error');
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('remixModal');
            if (event.target == modal) {
                closeRemixModal();
            }
        }
        
        // Auto-fill current wallet address for royalties
        document.getElementById('royaltyReceiver').addEventListener('focus', function() {
            if (userAddress && !this.value) {
                this.value = userAddress;
            }
        });
        
        // Pre-fill with MOJO defaults
        window.addEventListener('load', function() {
            document.getElementById('collectionName').value = 'MOJO PFP Collection';
            document.getElementById('symbol').value = 'MOJO';
            document.getElementById('maxSupply').value = '10000';
            document.getElementById('mintPrice').value = '0.01';
            document.getElementById('royaltyPercent').value = '7.5';
        });

        // ===== ADMIN CONTRACT MANAGEMENT FUNCTIONS =====
        
        let adminContract = null;
        let adminSigner = null;
        
        // Standard NFT ABI for admin functions
        const ADMIN_NFT_ABI = [
            "function owner() view returns (address)",
            "function totalSupply() view returns (uint256)",
            "function MAX_SUPPLY() view returns (uint256)",
            "function mintPrice() view returns (uint256)",
            "function setMintPrice(uint256 newPrice) external",
            "function withdraw() external",
            "function transferOwnership(address newOwner) external",
            "function royaltyInfo(uint256, uint256) view returns (address, uint256)",
            "function setRoyaltyInfo(address receiver, uint96 feeNumerator) external",
            "function mintingActive() view returns (bool)",
            "function toggleMinting() external"
        ];
        
        // Initialize admin contract
        async function initializeAdminContract() {
            const contractAddress = document.getElementById('contractAddress').value.trim();
            
            if (!contractAddress || !ethers.utils.isAddress(contractAddress)) {
                showAdminStatus('Please enter a valid contract address', 'error');
                return false;
            }
            
            if (!web3Provider) {
                const connected = await connectWallet();
                if (!connected) return false;
            }
            
            try {
                adminContract = new ethers.Contract(contractAddress, ADMIN_NFT_ABI, signer);
                adminSigner = signer;
                
                // Verify user is owner
                const owner = await adminContract.owner();
                const currentUser = await signer.getAddress();
                
                if (owner.toLowerCase() !== currentUser.toLowerCase()) {
                    showAdminStatus('‚ùå You are not the owner of this contract', 'error');
                    return false;
                }
                
                showAdminStatus('‚úÖ Contract connected successfully', 'success');
                return true;
            } catch (error) {
                showAdminStatus(`‚ùå Failed to connect to contract: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Load current payout wallet
        async function loadCurrentPayoutWallet() {
            if (!await initializeAdminContract()) return;
            
            try {
                const owner = await adminContract.owner();
                document.getElementById('payoutWallet').value = owner;
                showPayoutStatus('‚úÖ Current payout wallet loaded', 'success');
            } catch (error) {
                showPayoutStatus(`‚ùå Error loading payout wallet: ${error.message}`, 'error');
            }
        }
        
        // Update payout wallet (transfer ownership)
        async function updatePayoutWallet() {
            if (!await initializeAdminContract()) return;
            
            const newWallet = document.getElementById('payoutWallet').value.trim();
            
            if (!newWallet || !ethers.utils.isAddress(newWallet)) {
                showPayoutStatus('‚ùå Please enter a valid wallet address', 'error');
                return;
            }
            
            try {
                showPayoutStatus('üîÑ Updating payout wallet...', 'info');
                
                const tx = await adminContract.transferOwnership(newWallet);
                await tx.wait();
                
                showPayoutStatus('‚úÖ Payout wallet updated successfully!', 'success');
            } catch (error) {
                showPayoutStatus(`‚ùå Failed to update payout wallet: ${error.message}`, 'error');
            }
        }
        
        // Load supply information
        async function loadSupplyInfo() {
            if (!await initializeAdminContract()) return;
            
            try {
                const totalSupply = await adminContract.totalSupply();
                const maxSupply = await adminContract.MAX_SUPPLY();
                
                document.getElementById('currentSupply').value = totalSupply.toString();
                document.getElementById('currentMaxSupply').value = maxSupply.toString();
                
                showSupplyStatus('‚úÖ Supply information loaded', 'success');
            } catch (error) {
                showSupplyStatus(`‚ùå Error loading supply info: ${error.message}`, 'error');
            }
        }
        
        // Update max supply (reduce only)
        async function updateMaxSupply() {
            showSupplyStatus('‚ÑπÔ∏è Max supply is immutable on this contract. To stop future mints, use "Toggle Minting" below.', 'warning');
            return;
        }
        
        // Burn tokens (reduce circulating supply)
        async function burnTokens() {
            if (!confirm('‚ö†Ô∏è This will permanently destroy unsold NFT slots. Are you sure?')) {
                return;
            }
            
            showSupplyStatus('üî• Burn functionality requires custom implementation based on your contract', 'warning');
        }
        
        // Load current mint price
        async function loadMintPrice() {
            if (!await initializeAdminContract()) return;
            
            try {
                const mintPrice = await adminContract.mintPrice();
                const priceInEth = ethers.utils.formatEther(mintPrice);
                
                document.getElementById('currentMintPrice').value = priceInEth;
                showPriceStatus('‚úÖ Current mint price loaded', 'success');
            } catch (error) {
                showPriceStatus(`‚ùå Error loading mint price: ${error.message}`, 'error');
            }
        }
        
        // Update mint price
        async function updateMintPrice() {
            if (!await initializeAdminContract()) return;
            
            const newPrice = parseFloat(document.getElementById('newMintPrice').value);
            
            if (isNaN(newPrice) || newPrice < 0) {
                showPriceStatus('‚ùå Please enter a valid price', 'error');
                return;
            }
            
            try {
                showPriceStatus('üîÑ Updating mint price...', 'info');
                
                const priceInWei = ethers.utils.parseEther(newPrice.toString());
                const tx = await adminContract.setMintPrice(priceInWei);
                await tx.wait();
                
                showPriceStatus(`‚úÖ Mint price updated to ${newPrice} ETH`, 'success');
                loadMintPrice(); // Refresh the display
            } catch (error) {
                showPriceStatus(`‚ùå Failed to update mint price: ${error.message}`, 'error');
            }
        }
        
        // Load current minting state
        async function loadMintingState() {
            if (!await initializeAdminContract()) return;
            
            try {
                const mintingActive = await adminContract.mintingActive();
                document.getElementById('currentMintingState').value = mintingActive ? 'ACTIVE' : 'PAUSED';
                showMintingStatus('‚úÖ Minting state loaded', 'success');
            } catch (error) {
                showMintingStatus(`‚ùå Error loading minting state: ${error.message}`, 'error');
            }
        }
        
        // Toggle minting state
        async function toggleMintingState() {
            if (!await initializeAdminContract()) return;
            
            try {
                showMintingStatus('üîÑ Toggling minting state...', 'info');
                
                const tx = await adminContract.toggleMinting();
                await tx.wait();
                
                showMintingStatus('‚úÖ Minting state toggled successfully', 'success');
                loadMintingState(); // Refresh the display
            } catch (error) {
                showMintingStatus(`‚ùå Failed to toggle minting: ${error.message}`, 'error');
            }
        }
        
        // Status display functions
        function showAdminStatus(message, type) {
            // Use existing updateStatus function
            updateStatus(message, type);
        }
        
        function showPayoutStatus(message, type) {
            const statusDiv = document.getElementById('payoutStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }
        
        function showSupplyStatus(message, type) {
            const statusDiv = document.getElementById('supplyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }
        
        function showPriceStatus(message, type) {
            const statusDiv = document.getElementById('priceStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }
        
        function showMintingStatus(message, type) {
            const statusDiv = document.getElementById('mintingStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }

        // Load current royalty information
        async function loadRoyaltyInfo() {
            if (!await initializeAdminContract()) return;
            
            try {
                const royaltyReceiver = await adminContract.royaltyReceiver();
                const royaltyFeeNumerator = await adminContract.royaltyFeeNumerator();
                const royaltyPercentage = (royaltyFeeNumerator / 100).toFixed(1); // Convert basis points to percentage
                
                document.getElementById('currentRoyaltyReceiver').value = royaltyReceiver;
                document.getElementById('currentRoyaltyPercentage').value = royaltyPercentage + '%';
                showRoyaltyStatus('‚úÖ Current royalty information loaded', 'success');
            } catch (error) {
                showRoyaltyStatus(`‚ùå Error loading royalty info: ${error.message}`, 'error');
            }
        }
        
        // Update royalty information
        async function updateRoyaltyInfo() {
            if (!await initializeAdminContract()) return;
            
            const newReceiver = document.getElementById('newRoyaltyReceiver').value.trim();
            const newPercentage = parseFloat(document.getElementById('newRoyaltyPercentage').value);
            
            if (!newReceiver || !ethers.utils.isAddress(newReceiver)) {
                showRoyaltyStatus('‚ùå Please enter a valid receiver address', 'error');
                return;
            }
            
            if (isNaN(newPercentage) || newPercentage < 0 || newPercentage > 10) {
                showRoyaltyStatus('‚ùå Please enter a valid percentage (0-10%)', 'error');
                return;
            }
            
            try {
                showRoyaltyStatus('üîÑ Updating royalty information...', 'info');
                
                const feeNumerator = Math.floor(newPercentage * 100); // Convert percentage to basis points
                const tx = await adminContract.setRoyaltyInfo(newReceiver, feeNumerator);
                await tx.wait();
                
                showRoyaltyStatus(`‚úÖ Royalty updated: ${newPercentage}% to ${newReceiver}`, 'success');
                loadRoyaltyInfo(); // Refresh the display
            } catch (error) {
                showRoyaltyStatus(`‚ùå Failed to update royalty: ${error.message}`, 'error');
            }
        }
        
        function showRoyaltyStatus(message, type) {
            const statusDiv = document.getElementById('royaltyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }

        // ========== ESCROW MANAGEMENT FUNCTIONS ==========

        // Load escrow statistics
        async function loadEscrowStats() {
            if (!await initializeAdminContract()) return;
            
            try {
                const stats = await adminContract.getCollectionStats();
                const totalMinted = stats.totalMinted.toString();
                const totalClaimed = stats.totalClaimed.toString();
                const totalPending = stats.totalPending.toString();
                
                document.getElementById('totalPendingTokens').value = totalPending;
                document.getElementById('totalClaimedTokens').value = totalClaimed;
                
                showEscrowStatus(`‚úÖ Stats loaded: ${totalPending} pending, ${totalClaimed} released`, 'success');
            } catch (error) {
                showEscrowStatus(`‚ùå Error loading escrow stats: ${error.message}`, 'error');
            }
        }

        // Check pending tokens for a specific user
        async function checkUserPendingTokens() {
            if (!await initializeAdminContract()) return;
            
            const userAddress = document.getElementById('userAddressLookup').value.trim();
            
            if (!userAddress || !ethers.utils.isAddress(userAddress)) {
                showEscrowStatus('‚ùå Please enter a valid user address', 'error');
                return;
            }
            
            try {
                const pendingTokens = await adminContract.getUserPendingTokens(userAddress);
                const tokenIds = pendingTokens.map(id => id.toString());
                
                if (tokenIds.length === 0) {
                    showEscrowStatus(`‚úÖ No pending tokens for ${userAddress}`, 'success');
                } else {
                    showEscrowStatus(`‚úÖ User has ${tokenIds.length} pending tokens: ${tokenIds.join(', ')}`, 'success');
                }
            } catch (error) {
                showEscrowStatus(`‚ùå Error checking user tokens: ${error.message}`, 'error');
            }
        }

        // Show all pending tokens
        async function showAllPendingTokens() {
            if (!await initializeAdminContract()) return;
            
            try {
                showEscrowStatus('üîÑ Loading all pending tokens...', 'info');
                
                const allPendingTokens = await adminContract.getAllPendingTokens();
                const tokenIds = allPendingTokens.map(id => id.toString());
                
                const pendingList = document.getElementById('pendingTokensList');
                const pendingContent = document.getElementById('pendingTokensContent');
                
                if (tokenIds.length === 0) {
                    pendingContent.innerHTML = '<p>No pending tokens in escrow.</p>';
                } else {
                    let html = '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<tr><th style="border: 1px solid #ccc; padding: 8px;">Token ID</th><th style="border: 1px solid #ccc; padding: 8px;">Intended Recipient</th><th style="border: 1px solid #ccc; padding: 8px;">Actions</th></tr>';
                    
                    for (const tokenId of tokenIds) {
                        try {
                            const recipient = await adminContract.pendingClaims(tokenId);
                            html += `<tr>
                                <td style="border: 1px solid #ccc; padding: 8px;">#${tokenId}</td>
                                <td style="border: 1px solid #ccc; padding: 8px; font-family: monospace; font-size: 0.8em;">${recipient}</td>
                                <td style="border: 1px solid #ccc; padding: 8px;">
                                    <button onclick="releaseSingleTokenById('${tokenId}')" style="background: var(--restaurant-green); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Release</button>
                                </td>
                            </tr>`;
                        } catch (error) {
                            console.warn(`Could not get recipient for token ${tokenId}:`, error);
                        }
                    }
                    
                    html += '</table>';
                    pendingContent.innerHTML = html;
                }
                
                pendingList.style.display = 'block';
                showEscrowStatus(`‚úÖ Found ${tokenIds.length} pending tokens`, 'success');
                
            } catch (error) {
                showEscrowStatus(`‚ùå Error loading pending tokens: ${error.message}`, 'error');
            }
        }

        // Release a single token
        async function releaseSingleToken() {
            const tokenId = document.getElementById('tokenIdToRelease').value;
            if (!tokenId) {
                showEscrowStatus('‚ùå Please enter a token ID', 'error');
                return;
            }
            await releaseSingleTokenById(tokenId);
        }

        // Release a single token by ID (helper function)
        async function releaseSingleTokenById(tokenId) {
            if (!await initializeAdminContract()) return;
            
            try {
                showEscrowStatus(`üîÑ Releasing token #${tokenId}...`, 'info');
                
                const tx = await adminContract.claimToken(tokenId);
                await tx.wait();
                
                showEscrowStatus(`‚úÖ Token #${tokenId} released successfully!`, 'success');
                
                // Refresh displays
                loadEscrowStats();
                showAllPendingTokens();
                
            } catch (error) {
                showEscrowStatus(`‚ùå Failed to release token #${tokenId}: ${error.message}`, 'error');
            }
        }

        // Release all tokens for a specific user
        async function releaseAllUserTokens() {
            if (!await initializeAdminContract()) return;
            
            const userAddress = document.getElementById('userAddressToRelease').value.trim();
            
            if (!userAddress || !ethers.utils.isAddress(userAddress)) {
                showEscrowStatus('‚ùå Please enter a valid user address', 'error');
                return;
            }
            
            try {
                showEscrowStatus(`üîÑ Releasing all tokens for ${userAddress}...`, 'info');
                
                const tx = await adminContract.claimAllUserTokens(userAddress);
                await tx.wait();
                
                showEscrowStatus(`‚úÖ All tokens released for ${userAddress}!`, 'success');
                
                // Refresh displays
                loadEscrowStats();
                showAllPendingTokens();
                
            } catch (error) {
                showEscrowStatus(`‚ùå Failed to release user tokens: ${error.message}`, 'error');
            }
        }

        // Release ALL pending tokens (emergency function)
        async function releaseAllPendingTokens() {
            if (!await initializeAdminContract()) return;
            
            if (!confirm('‚ö†Ô∏è Are you sure you want to release ALL pending tokens? This cannot be undone!')) {
                return;
            }
            
            try {
                showEscrowStatus('üîÑ Loading all pending tokens for batch release...', 'info');
                
                const allPendingTokens = await adminContract.getAllPendingTokens();
                const tokenIds = allPendingTokens.map(id => id.toString());
                
                if (tokenIds.length === 0) {
                    showEscrowStatus('‚úÖ No pending tokens to release', 'success');
                    return;
                }
                
                showEscrowStatus(`üîÑ Releasing ${tokenIds.length} tokens in batches...`, 'info');
                
                // Release in batches of 20 to avoid gas limits
                const batchSize = 20;
                for (let i = 0; i < tokenIds.length; i += batchSize) {
                    const batch = tokenIds.slice(i, i + batchSize);
                    const batchNumber = Math.floor(i / batchSize) + 1;
                    const totalBatches = Math.ceil(tokenIds.length / batchSize);
                    
                    showEscrowStatus(`üîÑ Processing batch ${batchNumber}/${totalBatches} (${batch.length} tokens)...`, 'info');
                    
                    const tx = await adminContract.claimTokensBatch(batch);
                    await tx.wait();
                    
                    console.log(`‚úÖ Batch ${batchNumber} completed:`, batch);
                }
                
                showEscrowStatus(`‚úÖ All ${tokenIds.length} tokens released successfully!`, 'success');
                
                // Refresh displays
                loadEscrowStats();
                showAllPendingTokens();
                
            } catch (error) {
                showEscrowStatus(`‚ùå Failed to release all tokens: ${error.message}`, 'error');
            }
        }

        // ========== COLLECTION MANAGEMENT FUNCTIONS ==========

        // Load collection statistics
        async function loadCollectionStats() {
            if (!await initializeAdminContract()) return;
            
            try {
                const stats = await adminContract.getCollectionStats();
                const collectionInfo = await adminContract.collectionInfo();
                
                document.getElementById('collectionTotalSupply').value = stats.totalMinted.toString();
                document.getElementById('collectionMaxSupply').value = stats.maxSupply.toString();
                document.getElementById('collectionDescription').value = collectionInfo.description;
                document.getElementById('collectionExternalUrl').value = collectionInfo.externalUrl;
                document.getElementById('collectionImageUrl').value = collectionInfo.imageUrl;
                
                showCollectionStatus('‚úÖ Collection info loaded successfully', 'success');
            } catch (error) {
                showCollectionStatus(`‚ùå Error loading collection info: ${error.message}`, 'error');
            }
        }

        // Update collection metadata
        async function updateCollectionMetadata() {
            if (!await initializeAdminContract()) return;
            
            const description = document.getElementById('collectionDescription').value.trim();
            const externalUrl = document.getElementById('collectionExternalUrl').value.trim();
            const imageUrl = document.getElementById('collectionImageUrl').value.trim();
            
            if (!description) {
                showCollectionStatus('‚ùå Please enter a collection description', 'error');
                return;
            }
            
            try {
                showCollectionStatus('üîÑ Updating collection metadata...', 'info');
                
                const tx = await adminContract.updateCollectionInfo(description, externalUrl, imageUrl);
                await tx.wait();
                
                showCollectionStatus('‚úÖ Collection metadata updated successfully!', 'success');
                
            } catch (error) {
                showCollectionStatus(`‚ùå Failed to update collection metadata: ${error.message}`, 'error');
            }
        }

        // Status display functions for new sections
        function showEscrowStatus(message, type) {
            const statusDiv = document.getElementById('escrowStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }

        function showCollectionStatus(message, type) {
            const statusDiv = document.getElementById('collectionStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }
    </script>
</body>
</html>
