<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOJO NFT Collection - Admin Panel</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=2">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png?v=2">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png?v=2">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=2">
    <link rel="shortcut icon" href="favicon.ico?v=2">
    <!-- Paco Platform Fee Wallet: Configured via environment variable -->
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: var(--surface-dark);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-glow);
        }
        
        .deploy-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 1px solid var(--surface-accent);
            border-radius: var(--border-radius-md);
            background: var(--surface-darker);
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--restaurant-yellow);
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .deploy-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--border-radius-lg);
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all var(--transition-base);
            margin-top: 1rem;
        }
        
        .deploy-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }
        
        .deploy-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status-section {
            margin-top: 2rem;
            padding: 1rem;
            background: var(--surface-darker);
            border-radius: var(--border-radius-md);
            border-left: 4px solid var(--restaurant-green);
        }
        
        .deployed-contracts {
            margin-top: 2rem;
        }
        
        .contract-card {
            background: var(--surface-darker);
            padding: 1rem;
            border-radius: var(--border-radius-md);
            margin-bottom: 1rem;
            border: 1px solid var(--surface-accent);
        }
        
        .contract-address {
            font-family: 'Courier New', monospace;
            background: var(--surface-dark);
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            margin: 0.5rem 0;
            word-break: break-all;
        }
        
        .copy-btn {
            background: var(--restaurant-green);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        /* Admin Controls Styling */
        .admin-controls h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .admin-section {
            margin-bottom: 2rem;
        }
        
        .admin-section h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        
        .admin-section p {
            color: var(--text-muted);
            margin-bottom: 1rem;
        }
        
        .btn-warning {
            background: var(--restaurant-orange);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: var(--restaurant-red);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .admin-container {
                margin: 1rem;
                padding: 1rem;
            }
            
            .admin-section {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="adminGate" style="max-width: 480px; margin: 4rem auto; background: var(--surface-dark); border: 1px solid var(--surface-accent); border-radius: var(--border-radius-lg); padding: 1.5rem; text-align: center;">
        <h2 style="margin-bottom: 1rem;">Admin Access</h2>
        <p style="margin-bottom: 1rem; color: var(--text-muted);">Enter passcode to continue</p>
        <input id="adminPassInput" type="password" placeholder="Passcode" style="width: 100%; padding: 0.75rem; border-radius: var(--border-radius-md); border: 1px solid var(--surface-accent); background: var(--surface-darker); color: var(--text-primary);" />
        <button id="adminPassBtn" style="margin-top: 1rem; width: 100%; padding: 0.75rem; border-radius: var(--border-radius-md); border: none; background: var(--restaurant-green); color: white; font-weight: 700; cursor: pointer;">Unlock</button>
        <div id="adminPassMsg" style="margin-top: 0.75rem; color: var(--restaurant-red); display:none;">Incorrect passcode</div>
        <p style="margin-top: 0.75rem; color: var(--text-muted); font-size: 0.85rem;">Hint: set window.ADMIN_PASS in console for dev</p>
    </div>
    
    <div class="admin-container" id="adminApp" style="display:none;">
        <h1>üé® MOJO NFT Collection Setup</h1>
        <p>Deploy your MOJO NFT smart contract - <strong>One-time setup required</strong></p>
        
        <div class="info-box" style="background: var(--surface-darker); padding: 1rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-yellow);">
            <h3>üìã Before You Start:</h3>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li>You only need to do this <strong>ONCE</strong> for your collection</li>
                <li>Make sure you have ETH in your wallet for gas fees (~$50-200)</li>
                <li>Choose your collection details carefully (name/symbol can't be changed)</li>
                <li>After deployment, copy the contract address to your main app</li>
            </ul>
        </div>
        
        <div class="deploy-form">
            <div class="form-group">
                <label for="collectionName">Collection Name</label>
                <input type="text" id="collectionName" placeholder="e.g., MOJO PFP Collection" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="symbol">Symbol</label>
                    <input type="text" id="symbol" placeholder="e.g., MOJO" maxlength="10" required>
                </div>
                
                <div class="form-group">
                    <label for="maxSupply">Max Supply</label>
                    <input type="number" id="maxSupply" placeholder="10000" min="1" max="100000" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="mintPrice">Mint Price (ETH)</label>
                    <input type="number" id="mintPrice" placeholder="0.01" step="0.001" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="royaltyPercent">Royalty %</label>
                    <input type="number" id="royaltyPercent" placeholder="7.5" step="0.1" min="0" max="10" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="royaltyReceiver">Royalty Receiver Address</label>
                <input type="text" id="royaltyReceiver" placeholder="0x..." required>
            </div>
            
            <div class="form-group">
                <label for="network">Network</label>
                <select id="network" required>
                    <option value="">Select Network</option>
                    <option value="ethereum">Ethereum Mainnet</option>
                    <option value="polygon">Polygon</option>
                    <option value="goerli">Goerli Testnet</option>
                    <option value="mumbai">Mumbai Testnet</option>
                    <option value="abstract">Abstract</option>
                </select>
            </div>
            
            <div class="deployment-options" style="margin: 2rem 0;">
                <h3>üöÄ Deployment Options:</h3>
                
                <div class="option-card" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 1rem; border: 2px solid var(--restaurant-green);">
                    <h4>‚úÖ Option 1: Easy Deploy (Recommended)</h4>
                    <p>Use Remix IDE - no technical setup required</p>
                    <button class="deploy-btn" onclick="showRemixInstructions()" style="background: var(--restaurant-green);">
                        üìñ Show Step-by-Step Guide
                    </button>
                </div>
                
                <div class="option-card" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); border: 1px solid var(--surface-accent);">
                    <h4>‚ö° Option 2: Advanced Deploy</h4>
                    <p>Deploy directly from this page (requires MetaMask)</p>
                    <button class="deploy-btn" onclick="deployContract()" id="deployBtn">
                        üöÄ Deploy Contract Now
                    </button>
                </div>
            </div>
        </div>
        
        <div class="status-section" id="statusSection" style="display: none;">
            <h3>Deployment Status</h3>
            <div id="statusText">Ready to deploy...</div>
            <div id="progressBar" style="display: none;">
                <div style="background: var(--restaurant-green); height: 4px; border-radius: 2px; width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>
        
        <!-- Remix Instructions Modal -->
        <div id="remixModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
            <div style="background: var(--surface-dark); margin: 2rem auto; max-width: 800px; border-radius: var(--border-radius-lg); max-height: 90vh; overflow-y: auto;">
                <div style="padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2>üéØ Easy Contract Deployment Guide</h2>
                        <button onclick="closeRemixModal()" style="background: var(--restaurant-red); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--border-radius-md); cursor: pointer;">‚úï Close</button>
                    </div>
                    
                    <div class="step-guide">
                        <div class="step">
                            <h3>üìù Step 1: Prepare Your Information</h3>
                            <p>Fill out the form above first, then copy these values:</p>
                            <div id="contractParams" style="background: var(--surface-darker); padding: 1rem; border-radius: var(--border-radius-md); margin: 1rem 0; font-family: monospace;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="step">
                            <h3>üåê Step 2: Open Remix IDE</h3>
                            <p>Go to <a href="https://remix.ethereum.org" target="_blank" style="color: var(--restaurant-yellow);">remix.ethereum.org</a> in a new tab</p>
                        </div>
                        
                        <div class="step">
                            <h3>üìÑ Step 3: Create Contract File</h3>
                            <ol>
                                <li>Click "Create New File" in Remix</li>
                                <li>Name it: <code>MojoNFT.sol</code></li>
                                <li>Copy and paste this contract code:</li>
                            </ol>
                            <button onclick="copyContractCode()" style="background: var(--restaurant-green); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--border-radius-md); cursor: pointer; margin: 0.5rem 0;">üìã Copy Contract Code</button>
                            <textarea id="contractCode" readonly style="width: 100%; height: 200px; background: var(--surface-darker); color: var(--text-primary); border: 1px solid var(--surface-accent); border-radius: var(--border-radius-md); padding: 1rem; font-family: monospace; font-size: 0.8rem;"></textarea>
                        </div>
                        
                        <div class="step">
                            <h3>‚öôÔ∏è Step 4: Compile Contract</h3>
                            <ol>
                                <li>Click the "Solidity Compiler" tab (üìÑ icon)</li>
                                <li>Select compiler version: <strong>0.8.19</strong></li>
                                <li>Click "Compile MojoNFT.sol"</li>
                                <li>Wait for green checkmark ‚úÖ</li>
                            </ol>
                        </div>
                        
                        <div class="step">
                            <h3>üöÄ Step 5: Deploy Contract</h3>
                            <ol>
                                <li>Click "Deploy & Run Transactions" tab (üöÄ icon)</li>
                                <li>Select "Injected Provider - MetaMask"</li>
                                <li>Choose your network (Ethereum, Polygon, etc.)</li>
                                <li>Select "MojoNFT_Template" contract</li>
                                <li>Fill in constructor parameters (use values from Step 1)</li>
                                <li>Click "Deploy" and confirm in MetaMask</li>
                            </ol>
                        </div>
                        
                        <div class="step">
                            <h3>‚úÖ Step 6: Get Contract Address</h3>
                            <ol>
                                <li>After deployment, find your contract in "Deployed Contracts"</li>
                                <li>Copy the contract address (starts with 0x...)</li>
                                <li>Update your main NFT generator with this address</li>
                                <li>You're ready to mint NFTs! üéâ</li>
                            </ol>
                        </div>
                        
                        <div style="background: var(--restaurant-green); color: white; padding: 1rem; border-radius: var(--border-radius-md); margin-top: 2rem;">
                            <h4>üéØ Final Step:</h4>
                            <p>Update your <code>script.js</code> file with the new contract address:</p>
                            <code style="background: rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 4px; display: block; margin-top: 0.5rem;">
                                const NFT_CONTRACT_ADDRESS = "0xYourNewContractAddress";
                            </code>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="deployed-contracts" id="deployedContracts">
            <h3>üìã Contract Status</h3>
            <div id="contractsList">
                <div style="background: var(--surface-darker); padding: 1rem; border-radius: var(--border-radius-md); border-left: 4px solid var(--restaurant-yellow);">
                    <p><strong>‚ö†Ô∏è No contract deployed yet</strong></p>
                    <p>Use one of the deployment options above to create your NFT contract.</p>
                    <p>After deployment, update the contract address in your main application.</p>
                </div>
            </div>
        </div>

        <!-- Admin Controls Section -->
        <div class="admin-controls" id="adminControls" style="margin-top: 3rem;">
            <h2>‚öôÔ∏è Contract Management</h2>
            <p>Manage your deployed NFT contract settings</p>
            
            <!-- Contract Address Input -->
            <div class="form-group" style="margin-bottom: 2rem;">
                <label for="contractAddress">Contract Address</label>
                <input type="text" id="contractAddress" placeholder="0x..." style="width: 100%;">
                <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">Enter your deployed contract address to enable management features</small>
            </div>
            
            <!-- Payout Wallet Management -->
            <div class="admin-section" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-green);">
                <h3>üí∞ Payout Wallet Configuration</h3>
                <p>Set where NFT sale proceeds and royalties are sent</p>
                
                <div class="form-group">
                    <label for="payoutWallet">Payout Wallet Address</label>
                    <input type="text" id="payoutWallet" placeholder="0x6Dc7277Da5842041f4af527Fe6f6A209EF03BED4" style="width: 100%;">
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadCurrentPayoutWallet()" style="margin-right: 1rem;">
                        üìã Load Current
                    </button>
                    <button class="btn btn-primary" onclick="updatePayoutWallet()">
                        üíæ Update Payout Wallet
                    </button>
                </div>
                
                <div id="payoutStatus" style="margin-top: 1rem; display: none;"></div>
            </div>
            
            <!-- Supply Management -->
            <div class="admin-section" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-red);">
                <h3>üìä Supply Management</h3>
                <p>Manage the maximum supply of your NFT collection</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentSupply">Current Supply</label>
                        <input type="text" id="currentSupply" readonly style="background: var(--surface-accent);">
                    </div>
                    
                    <div class="form-group">
                        <label for="currentMaxSupply">Current Max Supply</label>
                        <input type="text" id="currentMaxSupply" readonly style="background: var(--surface-accent);">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newMaxSupply">New Max Supply</label>
                    <input type="number" id="newMaxSupply" placeholder="5000" min="1">
                    <small style="color: var(--text-muted); margin-top: 0.5rem; display: block;">‚ö†Ô∏è Can only be reduced, not increased. This will limit future minting.</small>
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadSupplyInfo()" style="margin-right: 1rem;">
                        üìä Refresh Supply Info
                    </button>
                    <button class="btn btn-warning" onclick="updateMaxSupply()" style="margin-right: 1rem;">
                        ‚ö†Ô∏è Reduce Max Supply
                    </button>
                    <button class="btn btn-danger" onclick="burnTokens()">
                        üî• Burn Unsold Supply
                    </button>
                </div>
                
                <div id="supplyStatus" style="margin-top: 1rem; display: none;"></div>
            </div>
            
            <!-- Mint Price Management -->
            <div class="admin-section" style="background: var(--surface-darker); padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem; border-left: 4px solid var(--restaurant-blue);">
                <h3>üíé Pricing Controls</h3>
                <p>Adjust the mint price for your NFTs</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentMintPrice">Current Mint Price (ETH)</label>
                        <input type="text" id="currentMintPrice" readonly style="background: var(--surface-accent);">
                    </div>
                    
                    <div class="form-group">
                        <label for="newMintPrice">New Mint Price (ETH)</label>
                        <input type="number" id="newMintPrice" placeholder="0.01" step="0.001" min="0">
                    </div>
                </div>
                
                <div class="form-row" style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="loadMintPrice()" style="margin-right: 1rem;">
                        üí∞ Load Current Price
                    </button>
                    <button class="btn btn-primary" onclick="updateMintPrice()">
                        üíæ Update Mint Price
                    </button>
                </div>
                
                <div id="priceStatus" style="margin-top: 1rem; display: none;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script>
        // ===== Simple Admin Passcode Gate =====
        (function() {
            const gate = document.getElementById('adminGate');
            const app = document.getElementById('adminApp');
            const input = document.getElementById('adminPassInput');
            const btn = document.getElementById('adminPassBtn');
            const msg = document.getElementById('adminPassMsg');

            // Configure passcode here (client-side). For real security, use HTTP Basic Auth or server middleware.
            const PASS = window.ADMIN_PASS || 'mojo';

            function unlock() {
                const val = (input.value || '').trim();
                if (val === PASS) {
                    gate.style.display = 'none';
                    app.style.display = '';
                } else {
                    msg.style.display = '';
                }
            }

            btn.addEventListener('click', unlock);
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') unlock(); });
        })();

        // Contract template for deployment
        const CONTRACT_TEMPLATE = `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Counters.sol";

contract MojoNFT_Template is ERC721, ERC721URIStorage, Ownable, ReentrancyGuard {
    using Counters for Counters.Counter;
    Counters.Counter private _tokenIdCounter;
    
    uint256 public immutable MAX_SUPPLY;
    uint256 public mintPrice;
    bool public mintingActive = true;
    address public royaltyReceiver;
    uint96 public royaltyFeeNumerator;
    
    constructor(
        string memory name,
        string memory symbol,
        uint256 _mintPrice,
        uint256 _maxSupply,
        address _royaltyReceiver,
        uint96 _royaltyFeeNumerator
    ) ERC721(name, symbol) {
        mintPrice = _mintPrice;
        MAX_SUPPLY = _maxSupply;
        royaltyReceiver = _royaltyReceiver;
        royaltyFeeNumerator = _royaltyFeeNumerator;
        _tokenIdCounter.increment();
    }
    
    function mint(address to, string memory tokenURI) public payable nonReentrant returns (uint256) {
        require(mintingActive, "Minting is not active");
        require(msg.value >= mintPrice, "Insufficient payment");
        require(_tokenIdCounter.current() <= MAX_SUPPLY, "Max supply exceeded");
        require(to != address(0), "Cannot mint to zero address");
        
        uint256 tokenId = _tokenIdCounter.current();
        _tokenIdCounter.increment();
        
        _safeMint(to, tokenId);
        _setTokenURI(tokenId, tokenURI);
        
        return tokenId;
    }
    
    function setMintPrice(uint256 newPrice) public onlyOwner {
        mintPrice = newPrice;
    }
    
    function toggleMinting() public onlyOwner {
        mintingActive = !mintingActive;
    }
    
    function withdraw() public onlyOwner {
        uint256 balance = address(this).balance;
        require(balance > 0, "No funds to withdraw");
        (bool success, ) = payable(owner()).call{value: balance}("");
        require(success, "Withdrawal failed");
    }
    
    function totalSupply() public view returns (uint256) {
        return _tokenIdCounter.current() - 1;
    }
    
    function tokensOfOwner(address owner) public view returns (uint256[] memory) {
        uint256 tokenCount = balanceOf(owner);
        if (tokenCount == 0) return new uint256[](0);
        
        uint256[] memory tokenIds = new uint256[](tokenCount);
        uint256 index = 0;
        
        for (uint256 tokenId = 1; tokenId < _tokenIdCounter.current(); tokenId++) {
            if (_exists(tokenId) && ownerOf(tokenId) == owner) {
                tokenIds[index++] = tokenId;
                if (index == tokenCount) break;
            }
        }
        return tokenIds;
    }
    
    function royaltyInfo(uint256, uint256 salePrice) external view returns (address receiver, uint256 royaltyAmount) {
        receiver = royaltyReceiver;
        royaltyAmount = (salePrice * royaltyFeeNumerator) / 10000;
    }
    
    function _burn(uint256 tokenId) internal override(ERC721, ERC721URIStorage) {
        super._burn(tokenId);
    }
    
    function tokenURI(uint256 tokenId) public view override(ERC721, ERC721URIStorage) returns (string memory) {
        return super.tokenURI(tokenId);
    }
    
    function supportsInterface(bytes4 interfaceId) public view override(ERC721, ERC721URIStorage) returns (bool) {
        return interfaceId == 0x2a55205a || super.supportsInterface(interfaceId);
    }
}`;
        
        const FACTORY_ABI = [
            "function deployCollection(string memory collectionName, string memory symbol, uint256 mintPrice, uint256 maxSupply, address royaltyReceiver, uint96 royaltyPercent) external payable returns (address)",
            "function getCreatorContracts(address creator) external view returns (address[] memory)",
            "function deploymentFee() external view returns (uint256)",
            "event CollectionDeployed(address indexed creator, address indexed contractAddress, string collectionName, string symbol)"
        ];
        
        let web3Provider = null;
        let signer = null;
        let userAddress = null;
        
        // Connect wallet on page load
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        await connectWallet();
                        loadDeployedContracts();
                    }
                } catch (error) {
                    console.error('Auto-connect failed:', error);
                }
            }
        });
        
        async function connectWallet() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                web3Provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = web3Provider.getSigner();
                userAddress = accounts[0];
                
                updateStatus(`Connected: ${userAddress.slice(0,6)}...${userAddress.slice(-4)}`, 'success');
                return true;
            } catch (error) {
                updateStatus('Failed to connect wallet', 'error');
                return false;
            }
        }
        
        async function deployContract() {
            try {
                // Validate form
                const collectionName = document.getElementById('collectionName').value.trim();
                const symbol = document.getElementById('symbol').value.trim().toUpperCase();
                const maxSupply = parseInt(document.getElementById('maxSupply').value);
                const mintPrice = parseFloat(document.getElementById('mintPrice').value);
                const royaltyPercent = parseFloat(document.getElementById('royaltyPercent').value);
                const royaltyReceiver = document.getElementById('royaltyReceiver').value.trim();
                const network = document.getElementById('network').value;
                
                if (!collectionName || !symbol || !maxSupply || !mintPrice || !royaltyReceiver || !network) {
                    updateStatus('Please fill in all fields', 'error');
                    return;
                }
                
                if (!ethers.utils.isAddress(royaltyReceiver)) {
                    updateStatus('Invalid royalty receiver address', 'error');
                    return;
                }
                
                // Connect wallet if not connected
                if (!web3Provider) {
                    const connected = await connectWallet();
                    if (!connected) return;
                }
                
                // Get factory contract
                const factoryAddress = FACTORY_ADDRESSES[network];
                if (!factoryAddress) {
                    updateStatus('Network not supported yet', 'error');
                    return;
                }
                
                const factory = new ethers.Contract(factoryAddress, FACTORY_ABI, signer);
                
                // Get deployment fee
                updateStatus('Getting deployment fee...', 'info');
                const deploymentFee = await factory.deploymentFee();
                
                // Prepare parameters
                const mintPriceWei = ethers.utils.parseEther(mintPrice.toString());
                const royaltyBasisPoints = Math.round(royaltyPercent * 100); // Convert % to basis points
                
                updateStatus('Deploying contract...', 'info');
                setDeployButtonState(true);
                
                // Deploy contract
                const tx = await factory.deployCollection(
                    collectionName,
                    symbol,
                    mintPriceWei,
                    maxSupply,
                    royaltyReceiver,
                    royaltyBasisPoints,
                    { value: deploymentFee }
                );
                
                updateStatus('Transaction submitted. Waiting for confirmation...', 'info');
                
                // Wait for confirmation
                const receipt = await tx.wait();
                
                // Find the deployed contract address from events
                const deployEvent = receipt.events?.find(e => e.event === 'CollectionDeployed');
                const contractAddress = deployEvent?.args?.contractAddress;
                
                if (contractAddress) {
                    updateStatus(`Contract deployed successfully!`, 'success');
                    addDeployedContract({
                        address: contractAddress,
                        name: collectionName,
                        symbol: symbol,
                        network: network,
                        txHash: receipt.transactionHash
                    });
                    
                    // Clear form
                    document.getElementById('collectionName').value = '';
                    document.getElementById('symbol').value = '';
                    document.getElementById('maxSupply').value = '';
                    document.getElementById('mintPrice').value = '';
                    document.getElementById('royaltyPercent').value = '';
                    document.getElementById('royaltyReceiver').value = '';
                    document.getElementById('network').value = '';
                } else {
                    updateStatus('Deployment completed but contract address not found', 'warning');
                }
                
            } catch (error) {
                console.error('Deployment error:', error);
                
                if (error.code === 'ACTION_REJECTED') {
                    updateStatus('Transaction rejected by user', 'error');
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    updateStatus('Insufficient funds for deployment', 'error');
                } else {
                    updateStatus(`Deployment failed: ${error.message}`, 'error');
                }
            } finally {
                setDeployButtonState(false);
            }
        }
        
        function updateStatus(message, type = 'info') {
            const statusSection = document.getElementById('statusSection');
            const statusText = document.getElementById('statusText');
            
            statusSection.style.display = 'block';
            statusText.textContent = message;
            
            // Update styling based on type
            statusSection.style.borderLeftColor = 
                type === 'success' ? 'var(--restaurant-green)' :
                type === 'error' ? 'var(--restaurant-red)' :
                type === 'warning' ? 'var(--restaurant-orange)' :
                'var(--restaurant-yellow)';
        }
        
        function setDeployButtonState(deploying) {
            const btn = document.getElementById('deployBtn');
            btn.disabled = deploying;
            btn.textContent = deploying ? '‚è≥ Deploying...' : 'üöÄ Deploy NFT Contract';
        }
        
        function addDeployedContract(contract) {
            const contractsList = document.getElementById('contractsList');
            
            // Remove "no contracts" message if it exists
            if (contractsList.children.length === 1 && contractsList.children[0].tagName === 'P') {
                contractsList.innerHTML = '';
            }
            
            const contractCard = document.createElement('div');
            contractCard.className = 'contract-card';
            contractCard.innerHTML = `
                <h4>${contract.name} (${contract.symbol})</h4>
                <div class="contract-address">
                    ${contract.address}
                    <button class="copy-btn" onclick="copyToClipboard('${contract.address}')">Copy</button>
                </div>
                <p><strong>Network:</strong> ${contract.network}</p>
                <p><strong>Transaction:</strong> 
                    <a href="https://etherscan.io/tx/${contract.txHash}" target="_blank" style="color: var(--restaurant-yellow);">
                        View on Explorer
                    </a>
                </p>
            `;
            
            contractsList.insertBefore(contractCard, contractsList.firstChild);
            
            // Save to localStorage
            saveContractToStorage(contract);
        }
        
        function loadDeployedContracts() {
            const saved = localStorage.getItem('deployedContracts');
            if (saved) {
                const contracts = JSON.parse(saved);
                contracts.forEach(contract => addDeployedContract(contract));
            }
        }
        
        function saveContractToStorage(contract) {
            const saved = localStorage.getItem('deployedContracts');
            const contracts = saved ? JSON.parse(saved) : [];
            contracts.unshift(contract);
            localStorage.setItem('deployedContracts', JSON.stringify(contracts));
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                updateStatus('Address copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }
        
        // Remix Instructions Functions
        function showRemixInstructions() {
            // Validate form first
            const collectionName = document.getElementById('collectionName').value.trim();
            const symbol = document.getElementById('symbol').value.trim().toUpperCase();
            const maxSupply = document.getElementById('maxSupply').value;
            const mintPrice = document.getElementById('mintPrice').value;
            const royaltyPercent = document.getElementById('royaltyPercent').value;
            const royaltyReceiver = document.getElementById('royaltyReceiver').value.trim();
            
            if (!collectionName || !symbol || !maxSupply || !mintPrice || !royaltyPercent || !royaltyReceiver) {
                updateStatus('Please fill in all fields above first', 'error');
                return;
            }
            
            // Populate contract parameters
            const mintPriceWei = (parseFloat(mintPrice) * 1e18).toString();
            const royaltyBasisPoints = Math.round(parseFloat(royaltyPercent) * 100);
            
            const paramsHtml = `
                <strong>Constructor Parameters (copy these exactly):</strong><br><br>
                <strong>name:</strong> "${collectionName}"<br>
                <strong>symbol:</strong> "${symbol}"<br>
                <strong>_mintPrice:</strong> ${mintPriceWei}<br>
                <strong>_maxSupply:</strong> ${maxSupply}<br>
                <strong>_royaltyReceiver:</strong> ${royaltyReceiver}<br>
                <strong>_royaltyFeeNumerator:</strong> ${royaltyBasisPoints}
            `;
            
            document.getElementById('contractParams').innerHTML = paramsHtml;
            document.getElementById('contractCode').value = CONTRACT_TEMPLATE;
            document.getElementById('remixModal').style.display = 'block';
        }
        
        function closeRemixModal() {
            document.getElementById('remixModal').style.display = 'none';
        }
        
        function copyContractCode() {
            const contractCode = document.getElementById('contractCode');
            contractCode.select();
            contractCode.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(contractCode.value).then(() => {
                updateStatus('Contract code copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                updateStatus('Failed to copy code - please select and copy manually', 'error');
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('remixModal');
            if (event.target == modal) {
                closeRemixModal();
            }
        }
        
        // Auto-fill current wallet address for royalties
        document.getElementById('royaltyReceiver').addEventListener('focus', function() {
            if (userAddress && !this.value) {
                this.value = userAddress;
            }
        });
        
        // Pre-fill with MOJO defaults
        window.addEventListener('load', function() {
            document.getElementById('collectionName').value = 'MOJO PFP Collection';
            document.getElementById('symbol').value = 'MOJO';
            document.getElementById('maxSupply').value = '10000';
            document.getElementById('mintPrice').value = '0.01';
            document.getElementById('royaltyPercent').value = '7.5';
        });

        // ===== ADMIN CONTRACT MANAGEMENT FUNCTIONS =====
        
        let adminContract = null;
        let adminSigner = null;
        
        // Standard NFT ABI for admin functions
        const ADMIN_NFT_ABI = [
            "function owner() view returns (address)",
            "function totalSupply() view returns (uint256)",
            "function MAX_SUPPLY() view returns (uint256)",
            "function mintPrice() view returns (uint256)",
            "function setMintPrice(uint256 newPrice) external",
            "function setMaxSupply(uint256 newMaxSupply) external",
            "function withdraw() external",
            "function transferOwnership(address newOwner) external",
            "function royaltyInfo(uint256, uint256) view returns (address, uint256)",
            "function burn(uint256 tokenId) external"
        ];
        
        // Initialize admin contract
        async function initializeAdminContract() {
            const contractAddress = document.getElementById('contractAddress').value.trim();
            
            if (!contractAddress || !ethers.utils.isAddress(contractAddress)) {
                showAdminStatus('Please enter a valid contract address', 'error');
                return false;
            }
            
            if (!web3Provider) {
                const connected = await connectWallet();
                if (!connected) return false;
            }
            
            try {
                adminContract = new ethers.Contract(contractAddress, ADMIN_NFT_ABI, signer);
                adminSigner = signer;
                
                // Verify user is owner
                const owner = await adminContract.owner();
                const currentUser = await signer.getAddress();
                
                if (owner.toLowerCase() !== currentUser.toLowerCase()) {
                    showAdminStatus('‚ùå You are not the owner of this contract', 'error');
                    return false;
                }
                
                showAdminStatus('‚úÖ Contract connected successfully', 'success');
                return true;
            } catch (error) {
                showAdminStatus(`‚ùå Failed to connect to contract: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Load current payout wallet
        async function loadCurrentPayoutWallet() {
            if (!await initializeAdminContract()) return;
            
            try {
                const owner = await adminContract.owner();
                document.getElementById('payoutWallet').value = owner;
                showPayoutStatus('‚úÖ Current payout wallet loaded', 'success');
            } catch (error) {
                showPayoutStatus(`‚ùå Error loading payout wallet: ${error.message}`, 'error');
            }
        }
        
        // Update payout wallet (transfer ownership)
        async function updatePayoutWallet() {
            if (!await initializeAdminContract()) return;
            
            const newWallet = document.getElementById('payoutWallet').value.trim();
            
            if (!newWallet || !ethers.utils.isAddress(newWallet)) {
                showPayoutStatus('‚ùå Please enter a valid wallet address', 'error');
                return;
            }
            
            try {
                showPayoutStatus('üîÑ Updating payout wallet...', 'info');
                
                const tx = await adminContract.transferOwnership(newWallet);
                await tx.wait();
                
                showPayoutStatus('‚úÖ Payout wallet updated successfully!', 'success');
            } catch (error) {
                showPayoutStatus(`‚ùå Failed to update payout wallet: ${error.message}`, 'error');
            }
        }
        
        // Load supply information
        async function loadSupplyInfo() {
            if (!await initializeAdminContract()) return;
            
            try {
                const totalSupply = await adminContract.totalSupply();
                const maxSupply = await adminContract.MAX_SUPPLY();
                
                document.getElementById('currentSupply').value = totalSupply.toString();
                document.getElementById('currentMaxSupply').value = maxSupply.toString();
                
                showSupplyStatus('‚úÖ Supply information loaded', 'success');
            } catch (error) {
                showSupplyStatus(`‚ùå Error loading supply info: ${error.message}`, 'error');
            }
        }
        
        // Update max supply (reduce only)
        async function updateMaxSupply() {
            if (!await initializeAdminContract()) return;
            
            const newMaxSupply = parseInt(document.getElementById('newMaxSupply').value);
            const currentMaxSupply = parseInt(document.getElementById('currentMaxSupply').value);
            
            if (!newMaxSupply || newMaxSupply <= 0) {
                showSupplyStatus('‚ùå Please enter a valid max supply', 'error');
                return;
            }
            
            if (newMaxSupply >= currentMaxSupply) {
                showSupplyStatus('‚ùå New max supply must be less than current max supply', 'error');
                return;
            }
            
            try {
                showSupplyStatus('üîÑ Updating max supply...', 'info');
                
                const tx = await adminContract.setMaxSupply(newMaxSupply);
                await tx.wait();
                
                showSupplyStatus(`‚úÖ Max supply reduced to ${newMaxSupply}`, 'success');
                loadSupplyInfo(); // Refresh the display
            } catch (error) {
                showSupplyStatus(`‚ùå Failed to update max supply: ${error.message}`, 'error');
            }
        }
        
        // Burn tokens (reduce circulating supply)
        async function burnTokens() {
            if (!confirm('‚ö†Ô∏è This will permanently destroy unsold NFT slots. Are you sure?')) {
                return;
            }
            
            showSupplyStatus('üî• Burn functionality requires custom implementation based on your contract', 'warning');
        }
        
        // Load current mint price
        async function loadMintPrice() {
            if (!await initializeAdminContract()) return;
            
            try {
                const mintPrice = await adminContract.mintPrice();
                const priceInEth = ethers.utils.formatEther(mintPrice);
                
                document.getElementById('currentMintPrice').value = priceInEth;
                showPriceStatus('‚úÖ Current mint price loaded', 'success');
            } catch (error) {
                showPriceStatus(`‚ùå Error loading mint price: ${error.message}`, 'error');
            }
        }
        
        // Update mint price
        async function updateMintPrice() {
            if (!await initializeAdminContract()) return;
            
            const newPrice = parseFloat(document.getElementById('newMintPrice').value);
            
            if (isNaN(newPrice) || newPrice < 0) {
                showPriceStatus('‚ùå Please enter a valid price', 'error');
                return;
            }
            
            try {
                showPriceStatus('üîÑ Updating mint price...', 'info');
                
                const priceInWei = ethers.utils.parseEther(newPrice.toString());
                const tx = await adminContract.setMintPrice(priceInWei);
                await tx.wait();
                
                showPriceStatus(`‚úÖ Mint price updated to ${newPrice} ETH`, 'success');
                loadMintPrice(); // Refresh the display
            } catch (error) {
                showPriceStatus(`‚ùå Failed to update mint price: ${error.message}`, 'error');
            }
        }
        
        // Status display functions
        function showAdminStatus(message, type) {
            // Use existing updateStatus function
            updateStatus(message, type);
        }
        
        function showPayoutStatus(message, type) {
            const statusDiv = document.getElementById('payoutStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }
        
        function showSupplyStatus(message, type) {
            const statusDiv = document.getElementById('supplyStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }
        
        function showPriceStatus(message, type) {
            const statusDiv = document.getElementById('priceStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? 'var(--restaurant-green)' : 
                                   type === 'error' ? 'var(--restaurant-red)' : 
                                   type === 'warning' ? 'var(--restaurant-orange)' : 'var(--restaurant-yellow)';
        }
    </script>
</body>
</html>
